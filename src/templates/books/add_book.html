{% load static %}
{% load crispy_forms_tags %}
{% load form_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Book</title>

  <link rel="stylesheet" href="{% static 'assets/css/book_form.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  {% comment %} <style>
    .sidebar {
      width: 240px;
      background: #f8f9fa;
      padding: 20px;
      border-right: 1px solid #ddd;
      height: 100vh;
    }
    .sidebar ul { padding: 0; list-style: none; }
    .sidebar li { margin-bottom: 10px; }
    .sidebar a { text-decoration: none; font-size: 16px; }
    .content { margin-left: 260px; padding: 30px; }
  </style> {% endcomment %}
</head>


<body>
  <div class="container container-fluid">
    {% comment %} <div class="row"> {% endcomment %}

      <!-- SIDEBAR -->
      <aside class="sidebar">
        <h2>Book Management</h2>
        <ul>
          <li><a href="{% url 'add-book' %}" class="active">âž• Add New Book</a></li>
          <li><a href="{% url 'bulk-upload' %}">ðŸ“¦ Bulk Upload</a></li>
        </ul>
      </aside>

      <!-- MAIN -->
      <main class="content">
        <h1>Add New Book</h1>

        <!-- Django messages -->
        {% if messages %}
          {% for msg in messages %}
            <div class="alert {{ msg.tags }}">{{ msg }}</div>
          {% endfor %}
        {% endif %}

        


        <!-- FORM -->
        <form id="bookUploadForm" method="post" enctype="multipart/form-data" class="p-4 border rounded bg-light">
            {% csrf_token %}

            <fieldset class="mb-4">
                <legend class="fw-bold mb-3">Book Details</legend>
                {{ form|crispy }}
            </fieldset>

            <fieldset class="mb-4">
                <legend class="fw-bold mb-3">Book Variant</legend>
                {{ variant_form|crispy }}
            </fieldset>

            <button type="submit" class="btn btn-primary w-100">Save Book</button>
            <!-- Upload progress bar -->
        <div id="upload-progress" class="mt-3 mb-4" style="display:none;">
          <label class="fw-bold">Upload Progress</label>
          <div class="progress">
              <div id="upload-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                   role="progressbar" style="width: 0%">0%</div>
          </div>
        </div>
          </form>

      </main>
    {% comment %} </div> {% endcomment %}
  </div>




  <!-- JS: Upload Progress Handler -->
  <script>
  document.getElementById("bookUploadForm").addEventListener("submit", function (e) {
      e.preventDefault(); // Stop default full-page submit

      let form = this;
      let url = form.getAttribute("action") || window.location.href;
      let formData = new FormData(form);

      // Show progress bar
      document.getElementById("upload-progress").style.display = "block";

      let xhr = new XMLHttpRequest();
      xhr.open("POST", url, true);

      // CSRF token
      xhr.setRequestHeader("X-CSRFToken",
          document.querySelector("[name=csrfmiddlewaretoken]").value
      );

      // TRACK PROGRESS
      xhr.upload.addEventListener("progress", function (e) {
          if (e.lengthComputable) {
              let percent = Math.round((e.loaded / e.total) * 100);
              let bar = document.getElementById("upload-bar");

              bar.style.width = percent + "%";
              bar.textContent = percent + "%";
          }
      });

      // SUCCESS
      xhr.onload = function () {
          let bar = document.getElementById("upload-bar");
          if (xhr.status === 200 || xhr.status === 201) {
              bar.classList.add("bg-success");
              bar.textContent = "Uploaded 100%";

              setTimeout(() => {
                  window.location.reload();
              }, 800);
          } else {
              bar.classList.add("bg-danger");
              bar.textContent = "Failed!";
              console.log(xhr.responseText);
              alert("Upload failed!");
          }
      };

      xhr.send(formData);
  });
  </script>

</body>
</html>
