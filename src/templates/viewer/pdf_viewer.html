<div class="container-fluid">
  <div class="pdf-controls d-flex justify-content-center align-items-center gap-3 mb-3">
  <button id="prev-page-top" class="btn btn-secondary btn-sm">Previous</button>
  <span>Page: <span id="page-num-top"></span> / <span id="page-count-top"></span></span>
  <button id="next-page-top" class="btn btn-secondary btn-sm">Next</button>
</div>

<div class="pdf-render-m d-flex justify-content-center"
     style="position: relative; max-height: 80vh; overflow-y:auto;">
  <canvas id="pdf-canvas" style="max-width: 100%; height: auto;"></canvas>

  <div id="loader"
       style="position: absolute; top:0;left:0;right:0;bottom:0;
              background:rgba(128,128,128,.7);display:none;
              justify-content:center;align-items:center;">
    <img src="/static/assets/img/loader.gif" alt="Loading..." />
  </div>
</div>

<div class="pdf-controls d-flex justify-content-center align-items-center gap-3 mb-3">
  <button id="prev-page-bottom" class="btn btn-secondary btn-sm">Previous</button>
  <span>Page: <span id="page-num-bottom"></span> / <span id="page-count-bottom"></span></span>
  <button id="next-page-bottom" class="btn btn-secondary btn-sm">Next</button>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.0.279/pdf.min.js"></script>
<script>
const url = '{{ pdf_url }}';
let pdfDoc = null,
    pageNum = 1,
    pageIsRendering = false,
    pageNumIsPending = null,
    canvas = document.getElementById('pdf-canvas'),
    ctx = canvas.getContext('2d');

const loader = document.getElementById('loader');
const showLoader = () => loader.style.display = 'flex';
const hideLoader = () => loader.style.display = 'none';

// render a single page into the single canvas
function renderPage(num) {
  pageIsRendering = true;
  showLoader();

  pdfDoc.getPage(num).then(page => {
    const containerWidth = document.querySelector('.pdf-render-m').clientWidth;
    const viewport = page.getViewport({ scale: 1 });
    const scale = (containerWidth / viewport.width) * 0.98;
    const scaledViewport = page.getViewport({ scale });

    canvas.height = scaledViewport.height;
    canvas.width = scaledViewport.width;

    return page.render({ canvasContext: ctx, viewport: scaledViewport }).promise;
  }).then(() => {
    pageIsRendering = false;
    hideLoader();
    // update both sets of counters
    document.getElementById('page-num-top').textContent = num;
    document.getElementById('page-num-bottom').textContent = num;

    if (pageNumIsPending !== null) {
      renderPage(pageNumIsPending);
      pageNumIsPending = null;
    }
  });
}

function queueRenderPage(num) {
  if (pageIsRendering) {
    pageNumIsPending = num;
  } else {
    renderPage(num);
  }
}

// buttons
function showPrevPage() {
  if (pageNum <= 1) return;
  pageNum--;
  queueRenderPage(pageNum);
}
function showNextPage() {
  if (pageNum >= pdfDoc.numPages) return;
  pageNum++;
  queueRenderPage(pageNum);
}

// attach handlers to both sets
document.getElementById('prev-page-top').addEventListener('click', showPrevPage);
document.getElementById('next-page-top').addEventListener('click', showNextPage);
document.getElementById('prev-page-bottom').addEventListener('click', showPrevPage);
document.getElementById('next-page-bottom').addEventListener('click', showNextPage);

// load PDF
pdfjsLib.getDocument(url).promise.then(pdf => {
  pdfDoc = pdf;
  document.getElementById('page-count-top').textContent = pdfDoc.numPages;
  document.getElementById('page-count-bottom').textContent = pdfDoc.numPages;
  renderPage(pageNum);
});

// re-render on window resize to keep scale responsive
window.addEventListener('resize', () => {
  if (pdfDoc) queueRenderPage(pageNum);
});

</script>
